# T-Head TH1520 4xC910 @ 1.85 Ghz, 8/16GB 64-bit LPDDR4, RV64GCV, 50GFLOP GPU, 4TOPS@int8 NPU

# FIXME-QA(Krey): ^ The use of first line of the config for description in TUI is stupid -> Implement DESCRIPTION

BOARD_MAINTAINER="chainsx kreyren"

# ./compile.sh build BOARD=sipeed-licheepi-4a BRANCH=legacy BUILD_DESKTOP=no BUILD_MINIMAL=yes EXPERT=yes KERNEL_CONFIGURE=no RELEASE=sid

# FIXME(Krey): SiPeed shows "alternative toolchain" that is more resource efficient that should be investigated and adapted
# FIXME(Krey): Declare UEFI as well WIP is in ref.6
# TODO(Krey): Implement edge kernel from The Beagles~
# TODO(Krey): Why is he doing msdos in grub, is he mad or am i https://github.com/chainsx/armbian-riscv-build/compare/911ed65ea5b37abf6e6fa0c8974083dcb0d7b8a2..081c7de1cfa9034009b64e7b129d93c38ce6c332?diff=unified#diff-285841053d4c0b64727695b9adc480fe64a06497e32b7801c32a73966409b859R15
# TODO(Krey): Installs 8GB DRAM on 16GB model
# TODO(Krey): The fan doesn't spin

# TODO(Krey): Handle this
# [ðŸ³|ðŸ”¨]   ===================== WARNING ======================
# [ðŸ³|ðŸ”¨]   This board does not use CONFIG_DM_USB. Please update
# [ðŸ³|ðŸ”¨]   the board to use CONFIG_DM_USB before the v2019.07 release.
# [ðŸ³|ðŸ”¨]   Failure to update by the deadline may result in board removal.
# [ðŸ³|ðŸ”¨]   See doc/driver-model/MIGRATION.txt for more info.
# [ðŸ³|ðŸ”¨]   ====================================================
# [ðŸ³|ðŸ”¨]   ===================== WARNING ======================
# [ðŸ³|ðŸ”¨]   CONFIG_OF_EMBED is enabled. This option should only
# [ðŸ³|ðŸ”¨]   be used for debugging purposes. Please use
# [ðŸ³|ðŸ”¨]   CONFIG_OF_SEPARATE for boards in mainline.
# [ðŸ³|ðŸ”¨]   See doc/README.fdt-control for more info.
# [ðŸ³|ðŸ”¨]   ====================================================

# FIXME(Krey): Figure out the GPU and NPU https://github.com/ryan4yin/nixos-licheepi4a/issues/11

# NOTE(Krey): Cannot be fixed as the migration from sid to trixied for riscv64 didn't yet started -> Bookworm will never support it and trixie will in the future -> use sid atm -> submit patch to debian that labels base-files as riscv64
## Refer to https://wiki.debian.org/RISC-V#Progress for progress, document this
# FIXME(Krey): bookworm and trixie fail bcs base-files are not provided -> Go annoy debian about it or fix it in armbian
## [ðŸ³|ðŸš¸] Could not find package filename for 'base-files' in 'https://packages.debian.org/bookworm/riscv64/base-files/download' [ looking for base-files ]
## [ðŸ³|ðŸš¸] Command failed, retrying in 15s [ apt_find_upstream_package_version_and_download_url base-files ]

# FIXME(Krey): Handle this
# [    2.563670]
# [    2.565219] ********************************************************************
# [    2.572714] **     NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE           **
# [    2.580204] **                                                                **
# [    2.587680] **  WRITEABLE clk DebugFS SUPPORT HAS BEEN ENABLED IN THIS KERNEL **
# [    2.595150] **                                                                **
# [    2.602619] ** This means that this kernel is built to expose clk operations  **
# [    2.610105] ** such as parent or rate setting, enabling, disabling, etc.      **
# [    2.617589] ** to userspace, which may compromise security on your system.    **
# [    2.625091] **                                                                **
# [    2.632561] ** If you see this message and you are not debugging the          **
# [    2.640030] ** kernel, report this immediately to your vendor!                **
# [    2.647498] **                                                                **
# [    2.654967] **     NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE NOTICE           **
# [    2.662433] ********************************************************************
# [    2.669998] random: fast init done

# FIXME(Krey): [FAILED] Failed to listen on systemd-networâ€¦t - Network Service Netlink Socket.

# NOTE(Krey): The following commands are needed to make the fan to spin:
## echo 1 > /sys/class/pwm/pwmchip0/export
## echo 1000000 > /sys/class/pwm/pwmchip0/pwm1/period

# NOTE(Krey): HDMI output doesn't work, but that might be cause I used minimal console image

# FIXME(Krey): Implement a method to handle flashing through fastboot to the eMMC namely separate:
## u-boot image
## boot
## root

# FIXME(Krey): I am unable to boot from an SD Card, but if uboot is placed on the eMMC it will allow sdcard initialization of rootfs

#! # SiPeed LicheePi 4A
#! System on Module board based on the T-Head TH1520 SoC with the chip, RAM, EMMC with a SODIMM-264 edge connector that slots into a platform board with additional devices.
#!
#! This documentation provides only armbian-specific instructions, refer to the official SiPeed Wiki for further details: https://wiki.sipeed.com/licheepi4a.html
#!
#! ## Flashing process
#!
#! ### Official Fastboot method to eMMC
#!
#! For the official method you will need `fastboot` often used to flash bootloaders on android devices and available in majority of Operating Systems and their distributions
#!
#! After successful build locate the u-boot binary, we will be using `u-boot-with-spl.bin`, but yours might have different name
#!
#! Disconnect the device from power, hold the 'BOOT' button and insert USB-C cable. On Linux it's recommended to monitor `# dmesg -w` to verify that your system sees the device and doesn't throw errors such as bad cable which will make the flashing unreliable.
#!
#! Verify that your fastboot sees the device
#!
#! ```console
#! # fastboot devices # Show Devices
#! ```
#!
#! You want to see `?????????????? Android Debugger` if that doesn't happen then seek help in the armbian support channel
#!
#! ```console
#! # fastboot flash ram ./output/images/u-boot-with-spl.bin # Flash the bootloader to temporary filesystem so that we can use it for flashing
#! # fastboot reboot # Reboot the device
#! ```
#!
#! Wait for the device to reboot, can be verified in `# dmesg -w`.
#!
#! Do NOT power the device with the 12VDC2A adapter, the flashing is done from the power provided by the USB-C cable
#!
#! ```console
#! # fastboot flash uboot ./output/images/u-boot-with-spl.bin # Flash the bootloader on the device
#! ```
#!
#! Verify in the output that the flashing was successful, if so proceed to flash the rootfs
#!
#! ```console
#! # fastboot flash root ./output/images/SOMETHING_HERE_AAAAAAAAAAAA.img_I_THINK
#! ```
#!
#! Flashing the rootfs might take some time, once it's done then disconned the USB-C cable, wait for the capacitors to discharge (~30 sec) and then power the device from the 12VDC2A adapter and you should be greeted by your Armbian Distribution

BOARD_NAME="SiPeed LicheePi 4A"
BOARDFAMILY="thead"

#! ## Partitioning

# gpt is used in the official image by SiPeed[3.1], msdos was not tested and not recommended
IMAGE_PARTITION_TABLE="gpt"

#! ## OpenSBI

case "$BRANCH" in
	"legacy"|"current")
		OPENSBISOURCE="https://github.com/revyos/thead-opensbi"
		OPENSBIDIR="opensbi"
		OPENSBIBRANCH="branch:lpi4a"
		OPENSBI_USE_GCC="> 6.3"
		OPENSBI_TARGET_MAP=";;build/platform/generic/firmware/fw_dynamic.bin"
		;;
	*) exit_with_error "OpenSBI is not implemented for release '$BRANCH'"
esac

#! ## Bootloader

BOOT_FDT_FILE="thead/light-lpi4a.dtb"
SRC_EXTLINUX="yes"
BOOTFS_TYPE="fat"
BOOTSIZE="512"
UBOOT_TARGET_MAP=";;u-boot-with-spl.bin"

case "$BRANCH" in
	"legacy")
		BOOTSOURCE="https://github.com/chainsx/thead-u-boot"
		BOOTBRANCH="branch:extlinux"
		BOOTPATCHDIR="legacy"
		;;
	"current")
		BOOTSOURCE="https://github.com/chainsx/thead-u-boot"
		BOOTBRANCH="branch:extlinux"
		BOOTPATCHDIR="legacy"
		;;
	*) exit_with_error "Bootloader for branch '$BRANCH' is not implemented for board '$BOARD', fixme?"
esac

#! ## Kernel
#! As of 07.09.2023-EU the sipeed upstream appears to started work on linux mainline patches LTS 5.10.113 X months ago and are now in the process of porting in the current LTS[5] and BeagleBoard developers working on edge kernel for BeagleV-Ahead[1] that will then require cherry-picking for licheepi 4a
#! Thus Legacy is considered the most reliable atm, current as testing and edge as development branch

KERNEL_TARGET="legacy,current,edge"

case "$BRANCH" in
	"legacy")
		KERNELSOURCE='https://github.com/revyos/thead-kernel'
		KERNELBRANCH="branch:lpi4a"
		declare -g KERNEL_MAJOR_MINOR="5.10"
		KERNELPATCHDIR="thead-${BRANCH}"
		LINUXCONFIG="linux-thead-${BRANCH}"
		;;
	*) exit_with_error "Kernel release of '$BRANCH' is not implemented for board '$BOARD'"
esac

# Enable serial console by default
SERIALCON="ttyS0:115200"

# NOTE(Krey): Declaring serial seems to have negative effect on things?
## DEFAULT_CONSOLE="serial"

# FIXME-QA(Krey): `console=ttyS0,115200` was removed and replaced by DEFAULT_CONSOLE and SERIALCON, verify that it works as expected
SRC_CMDLINE="rootwait rw earlycon clk_ignore_unused loglevel=7 eth=$ethaddr rootrwoptions=rw,noatime rootrwreset=yes"

#! ## Blobs
#! The board requires the following blobs:
#! * b.1. light_aon_fpga - FIXME: Rationale
#! * b.2. light_c906_audio - FIXME: Rationale
#! * b.3. fw_dynamic - FIXME: Rationale
function post_family_tweaks__licheepi4a() {
	# FIXME(Krey): Liberate this garbage, found in https://github.com/revyos/th1520-boot-firmware/tree/master/addons/boot
	# FIXME(Krey): Include this in family scope
	display_alert "Applying blobs >:("

	# E902 aon fw
	cp -v "$SRC/packages/blobs/riscv64/thead/light_aon_fpga.bin" "$SDCARD/boot/light_aon_fpga.bin"

	# C906 audio fw
	cp -v "$SRC/packages/blobs/riscv64/thead/light_c906_audio.bin" "$SDCARD/boot/light_c906_audio.bin"

	# FIXME(Krey): Replace this with logic that builds this
	# opensbi -- https://github.com/revyos/thead-opensbi
	cp -v "$SRC/packages/blobs/riscv64/thead/fw_dynamic.bin" "$SDCARD/boot/fw_dynamic.bin"
}

#! ## Misc

SKIP_BOOTSPLASH="no"

#! ## Known Issues
#! k.1. SuperTuxKart doesn't work with GPU Err
#! k.2. Playing CrabRave results in weird poping sounds
#! k.3. Chromium provided with `--no-sandbox` for some reason
#! k.4. glxgears are not glxgearing
#! k.5. Some genius though that it's a good idea to ancor the cooler just by thermal pad thing, expect it to keep falling and annoy the hug out of you, 3D printing/CNC community save MeEEEEeeEEEeeeeeeeeeeeeEEEeeeeeEE and someone tell SiPeed in a diplomatic way to provide alternative cooler, bcs i suck at diplomacy
#! k.6. Serial console doesn't work until you re-flash the thing with new OS
#! k.7. The Slovenians still didn't added me in CODEOWNERS =..=

#! ## Relevants
#! 1. BeagleDevs mainline status for BeagleV-Ahead -- https://forum.beagleboard.org/t/upstream-linux-th1520-patch-series/35780
#! 2. BeagleDevs mainline status for TH1520 patch series with initial DTS -- https://forum.beagleboard.org/t/upstream-linux-th1520-patch-series/35780
#! 3. Official documentation by SiPeed -- https://wiki.sipeed.com/licheepi4a.html
#! 3.1 Information on available images -- https://wiki.sipeed.com/hardware/en/lichee/th1520/lpi4a/3_images.html
#! 4. PostMarketOS wiki on the board -- https://wiki.postmarketos.org/wiki/Sipeed_Lichee_Pi_4A_(sipeed-licheepi4a)
#! 5. T-Head kernel source by revyos -- https://github.com/revyos/thead-kernel
#! 6. chainsx's changes -- https://github.com/chainsx/armbian-riscv-build/compare/911ed65ea5b37abf6e6fa0c8974083dcb0d7b8a2..081c7de1cfa9034009b64e7b129d93c38ce6c332
